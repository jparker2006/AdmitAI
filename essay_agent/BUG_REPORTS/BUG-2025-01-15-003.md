# Bug Report BUG-2025-01-15-003

## BUG-2025-01-15-003

**Date**: 2025-01-15  
**Reporter**: Comprehensive Test Suite  
**Severity**: **CRITICAL**  
**Status**: New

## Summary
Draft tool systematically fails across all scenarios with empty outline parameter, causing 100% failure rate in conversation workflows

## Test Scenario
**Affected Scenarios**: HP-001, HP-003, HP-004, HP-005, ER-001, ER-002, ER-003, EC-004, EC-005 (9/11 scenarios)  
**Error Pattern**: "Failed to generate draft meeting word count requirements: Failed to generate draft after 3 attempts: 'draft'"  
**Test Command**: `python tests/run_conversation_tests.py --all`

## Expected Behavior
Draft tool should generate essay content successfully when provided with:
- Valid user profile
- Essay context (college target, essay type)
- Word count requirement (650 words)

## Actual Behavior
Draft tool fails after 3 retry attempts in 9/11 test scenarios with identical error message across different:
- User profiles (achiever_stem, creative_passionate, identity_explorer, service_leader)
- Essay prompts (Stanford, MIT, Harvard, Common App)
- Word counts (100, 650, 1000 words)

## Error Details
```
‚ö†Ô∏è  Tool 'draft' failed on attempt 1/3: ValueError
üîÑ Retrying in 2.0s...
‚ö†Ô∏è  Tool 'draft' failed on attempt 2/3: ValueError
üîÑ Retrying in 4.0s...
‚ö†Ô∏è  Tool 'draft' failed on attempt 3/3: ValueError
[DEBUG] Tool draft returned: {'ok': None, 'error': ToolError(type='ValueError', message="Failed to generate draft meeting word count requirements: Failed to generate draft after 3 attempts: 'draft'")}
```

## Root Cause Analysis
**Primary Issue**: Empty outline parameter
```json
{
  "outline": {},  // PROBLEM: Empty outline passed to draft tool
  "profile": "{valid_profile_json}",
  "voice_profile": "{valid_voice_profile_json}",
  "word_count": 650
}
```

**Secondary Issues**:
1. **Missing Essay Prompt**: Enhanced prompt extraction returns `None` 
2. **Conversation State**: Draft content not properly saved for subsequent tools
3. **Retry Logic**: Same parameters retried without addressing root cause

## Impact Assessment
- **User Experience**: Complete workflow breakdown - no essays can be generated
- **Data Integrity**: Conversation state saved but no essay content created
- **System Stability**: Consistent failures across all user types and prompts
- **Pass Rate**: 0% success rate in comprehensive testing

## Affected User Flows
1. **Happy Path Workflows**: All 5 scenarios fail at draft generation
2. **Error Recovery**: All 3 scenarios fail with same draft issues  
3. **Edge Cases**: 2/3 scenarios fail with draft generation

## Tool Parameters at Failure (Typical)
```json
{
  "profile": "{850+ character valid profile JSON}",
  "outline": {},  // CRITICAL: Empty outline
  "voice_profile": "{850+ character valid voice profile JSON}", 
  "word_count": 650,
  "essay_prompt": "Generate personal stories and experiences for college essays"  // Generic fallback
}
```

## Investigation Areas
1. **Draft Tool Requirements**: Does draft tool require non-empty outline?
2. **Conversation Flow**: Why isn't outline tool called before draft tool?
3. **Prompt Extraction**: Why does enhanced prompt extraction return None?
4. **Intent Recognition**: Why are direct draft requests not triggering proper workflow?

## Related Issues
- **BUG-2025-01-15-002**: Cascading failures in revise/polish tools due to empty drafts
- **Test Validation Issue**: Expected patterns not matching actual conversation output

---

## Bug Report Checklist
- [x] Clear reproduction steps provided (run full test suite)
- [x] Error messages/logs included (consistent across 9 scenarios)
- [x] Impact assessment completed (0% pass rate, critical severity)
- [x] Severity level assigned (Critical - blocks all essay generation)
- [x] Root cause analysis documented (empty outline parameter) 